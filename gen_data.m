clearvars;

G_adj = [0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 1 0 0 1 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 1 1 1 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 1 0 1 1 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 1 0 1 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 1 0 0 0 0 1 0 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 1 1 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 1 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 1 1 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 0 0 0 0 0 1 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 0 1 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 1 1 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 1 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 0 0 0 ...
  0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 0 1 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 1 0 0 0 1 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 ...
  1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 ...
  0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 ...
  0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 ...
  0 1 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 ...
  1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 ...
  1 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 ...
  0 0 0 0 1 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 1 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 ...
  0 0 1 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 1 0 0 0 1 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 1 1 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  1 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 1 0 0 0 0 1 0 1 1 0 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 0 0 0 0 0 1 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 1 1 0 1 0 1 0 0 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 1 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 1 1 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 0 1;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 1 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1;
 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ...
  0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0];

node_list = [0, 7, 3, 8, 1, 2, 4, 10, 5, 6, 9, 11, 13, 14, 16, 12, 15, 17, 19, 20, 22, 18, 21, 23, 25, 26, 28, 24, 27, 29, 31, 32, 34, 30, 33, 35, 37, 38, 40, 36, 39, 41, 43, 44, 46, 42, 45, 47, 49, 50, 52, 48, 51, 53, 55, 56, 58, 54, 57, 59]';
n = length(node_list);
[~, node_perm] = sort(node_list, 'ascend');
node_perm_mat = eye(n);
node_perm_mat = node_perm_mat(node_perm, :);

G_adj = logical(node_perm_mat * G_adj * node_perm_mat');
G = graph(G_adj);
dist_mat = distances(G);

Bmax = max(max(dist_mat));

Q = [1.3248690727326484, 0.877648717269985 , 0.8943656495473089, ...
        0.7854062755687659, 1.1730815258649356, 0.5396922606239434, ...
        1.3489623528432961, 0.8477586198209794, 1.0638078192114198, ...
        0.950125924904518 , 1.2924215874089948, 0.5879718581004691, ...
        0.9355165591972985, 0.9231891290663169, 1.2267538884670874, ...
        0.7800217465371938, 0.9655143584899128, 0.8244283164157257, ...
        1.0084427493431185, 1.1165630427431645, 0.7798761645574157, ...
        1.228944741967923 , 1.180318144118559 , 1.1004988677803738, ...
        1.1801711898528824, 0.8632544281651333, 0.9754219548962704, ...
        0.8128461131481862, 0.9464223840747968, 1.1060710933476372, ...
        0.8616678496549381, 0.9206492946288045, 0.8625654599760801, ...
        0.8309588717002561, 0.8657507738326362, 0.9974670802162198, ...
        0.7765379302729445, 1.0468831395634184, 1.331960435421974 , ...
        1.148408832115467 , 0.961632889527677 , 0.8224742071830328, ...
        0.8505683412498325, 1.3384909202055493, 1.0101615509552058, ...
        0.8726008706861293, 1.0381830969334933, 1.4200510272957685, ...
        1.0240317904963259, 1.1234406219414839, 1.0600340639911654, ...
        0.9295500307012963, 0.771496360395572 , 0.9301314555174245, ...
        0.9582211533250444, 1.1173246382364395, 1.1677966827749011, ...
        1.1862204162607115, 1.0571174650508517, 1.1770282328541457]';

routes_coeffs = [0.6035183527973222, 1.0022945241866303, 0.4103438563344071;
       0.2384742680821725, 0.3908145172299977, 0.0604573704168446;
       0.9053035099611416, 1.2158534531377592, 1.7484603252265292;
       1.1171970683905101, 1.1552910443436717, 0.403572690357161 ;
       0.1280296555582644, 0.7009351368929799, 0.2525079577932842;
       1.6177609726592026, 0.2449632101026975, 0.662379714085797 ;
       0.1840757882915067, 0.6096089442496199, 0.1778625140882874;
       0.160606455143998 , 0.1492491127906274, 0.3280413177666051;
       0.1586397761014158, 0.0952069166459671, 0.5365298290312245;
       0.3020510290567355, 0.0974570167931496, 0.9035871263295358;
       0.9591343039212057, 0.1481251339871551, 0.3002279600720914;
       0.510984325963378 , 0.3387954832512903, 0.0618720546788475;
       0.2750829404568605, 0.0348774854673976, 0.4960006751585034;
       0.5584256272577751, 0.3577028518287986, 0.9796061638443991;
       0.32279331343264  , 0.4748628185896536, 0.8759294765928335;
       0.1355059464469345, 0.5924451608770198, 0.7629604814463478;
       0.2129748048028977, 0.0260916373546869, 1.0984938561974047;
       0.2521275136338334, 0.6769285180680268, 0.6876127526655891;
       0.2804367829312859, 1.0498267289899454, 0.0309564074128409;
       1.2926178837626359, 0.8971341665885313, 0.3271204303494623;
       0.0196935647006227, 0.6201292953353277, 1.0190047441270214;
       1.573681399403788 , 1.4863854915574017, 0.9889312243622563];

m = size(routes_coeffs, 1);
   
agent_route_tab = zeros(n, m);
for k = 1:n/6
    agent_route_tab((k-1)*6+1:k*6, k*2-1:k*2+2) = 1;
end
agent_route_tab = logical(agent_route_tab);
agent_route_list = cell(n, 1);
nr = zeros(n, 1);
for k = 1:n
    agent_route_list{k} = find(agent_route_tab(k, :))';
    nr(k) = length(agent_route_list{k});
end

fn_dependence_mat = zeros(n, n);
for k = 1:n
    for j = 1:m
        if agent_route_tab(k, j)
            fn_dependence_mat(k, agent_route_tab(:, j)') = 1;
        end
    end
end
fn_dependence_mat = logical(fn_dependence_mat);
fn_dependence = cell(n, 1);
for k = 1:n
    fn_dependence{k} = find(fn_dependence_mat(k, :));
end

% x0 = zeros(sum(nr)-n, 1);
% Amat = zeros(n, sum(nr)-n);
% bvec = ones(n, 1);
% ptr = 1;
% func = @(x)(global_func_opt(x, Q, nr, routes_coeffs, agent_route_list));
% options = optimoptions(@fmincon, 'MaxFunctionEvaluations', 10000);
% for k = 1:n
%     x0(ptr:ptr+nr(k)-2) = ones(nr(k)-1,1)/nr(k);
%     Amat(k, ptr:ptr+nr(k)-2) = 1;
%     ptr = ptr + nr(k) - 1;
% end
% [x_opt, f_opt] = fmincon(func, x0, Amat, bvec, [], [], zeros(sum(nr)-n, 1), ones(sum(nr)-n, 1), [], options);

x0 = [3.0092143449105913e-01, 6.2665085975199641e-01, ...
       3.6071033417891425e-02, 3.6356672341795446e-02, ...
       3.3522664190666390e-01, 5.5994285017557921e-01, ...
       5.2230481284348762e-02, 5.2600026635876193e-02, ...
       3.3403494372023307e-01, 5.6285210521134343e-01, ...
       5.1373755933281008e-02, 5.1739195137633420e-02, ...
       3.4146780359240209e-01, 5.4308908719245075e-01, ...
       5.7524282394906381e-02, 5.7918826822575036e-02, ...
       3.1279767711569256e-01, 6.0624769717733651e-01, ...
       4.0322533247793321e-02, 4.0632092461920039e-02, ...
       3.5287038252628572e-01, 4.8928731054640068e-01, ...
       7.8677799149682870e-02, 7.9164507779565269e-02, ...
       1.5896677737700424e-01, 1.6377376644825342e-01, ...
       5.4222250882946277e-01, 1.3503694734803989e-01, ...
       1.9384738425326539e-01, 1.9819289913114543e-01, ...
       4.3699669831443849e-01, 1.7096301830359142e-01, ...
       1.7804097930602000e-01, 1.8271339404638626e-01, ...
       4.8513096967562086e-01, 1.5411465697470747e-01, ...
       1.8624209076985226e-01, 1.9077266228987555e-01, ...
       4.6027490772850882e-01, 1.6271033921434733e-01, ...
       1.6254602585501413e-01, 1.6734614985294874e-01, ...
       5.3157970478912253e-01, 1.3852811950567495e-01, ...
       2.1342521316361690e-01, 2.1699818530785098e-01, ...
       3.7571894638530190e-01, 1.9385765514526171e-01, ...
       1.0323174617802787e-01, 7.1651623078086840e-02, ...
       3.5898028153757361e-01, 4.6613634920886676e-01, ...
       1.0424804084546965e-01, 7.2424457081317631e-02, ...
       3.5888080379651471e-01, 4.6444669827923640e-01, ...
       8.3606462739769058e-02, 5.7096478415790325e-02, ...
       3.5754047650171478e-01, 5.0175658234547627e-01, ...
       1.1751586772498353e-01, 8.2737109717605617e-02, ...
       3.5637448880326589e-01, 4.4337253375647789e-01, ...
       1.0083303643783284e-01, 6.9836394302311172e-02, ...
       3.5915599692413969e-01, 4.7017457233831189e-01, ...
       1.1309180761754754e-01, 7.9249998270474714e-02, ...
       3.5744224066431790e-01, 4.5021595345005844e-01, ...
       1.9652011187013702e-01, 2.4101960322096544e-01, ...
       3.2401118359922992e-01, 2.3844910131231797e-01, ...
       1.9147148609076220e-01, 2.3931463659071320e-01, ...
       3.3273137562232241e-01, 2.3648250169891388e-01, ...
       2.0763128254465307e-01, 2.4420139700980942e-01, ...
       3.0599458154192977e-01, 2.4217273890593735e-01, ...
       1.8636472139272894e-01, 2.3742005961321974e-01, ...
       3.4190790342172384e-01, 2.3430731557503928e-01, ...
       1.8855540916321248e-01, 2.3825572324669500e-01, ...
       3.3792655905917740e-01, 2.3526230853362681e-01, ...
       1.9221411280751108e-01, 2.3957469972435216e-01, ...
       3.3142718290745815e-01, 2.3678400456339030e-01, ...
       3.8759060337484774e-01, 2.6188277632765872e-01, ...
       1.4780248128699847e-01, 2.0272413901320749e-01, ...
       3.4922265723398599e-01, 2.6393002800270765e-01, ...
       1.6890230000385784e-01, 2.1794501476190054e-01, ...
       3.6279973638955171e-01, 2.6356907097355592e-01, ...
       1.6099298880097793e-01, 2.1263820383852128e-01, ...
       3.4311564579814757e-01, 2.6394206781661977e-01, ...
       1.7264334445658214e-01, 2.2029894193102986e-01, ...
       3.5929351435905577e-01, 2.6370527379507219e-01, ...
       1.6298413645570334e-01, 2.1401707539273643e-01, ...
       3.7862298400503935e-01, 2.6263665516871704e-01, ...
       1.5240325692839385e-01, 2.0633710390056220e-01, ...
       1.6122543134839024e-01, 2.0687413730657764e-01, ...
       3.9246402906710942e-01, 2.3943640228037225e-01, ...
       1.5659303552565951e-01, 2.0326278272764034e-01, ...
       4.0283208653820085e-01, 2.3731209521103147e-01, ...
       1.6115357328894889e-01, 2.0681932154622407e-01, ...
       3.9262212908971750e-01, 2.3940497607756064e-01, ...
       1.6370958470219912e-01, 2.0874662547019668e-01, ...
       3.8705026321952041e-01, 2.4049352661048939e-01, ...
       1.6089889893778395e-01, 2.0662470246807466e-01, ...
       3.9318315447355306e-01, 2.3929324412304384e-01, ...
       1.5082804700553462e-01, 1.9854774106836240e-01, ...
       4.1624452200596584e-01, 2.3437968992277328e-01, ...
       2.1740315825828682e-01, 1.5950539887653695e-01, ...
       2.7321897884338209e-01, 3.4987246402411676e-01, ...
       2.0257773475637805e-01, 1.3864900617530806e-01, ...
       2.7382774769343077e-01, 3.8494551137758082e-01, ...
       1.8707302738116605e-01, 1.2092222891419240e-01, ...
       2.7131219649785387e-01, 4.2069254720955362e-01, ...
       1.9698932219580662e-01, 1.3188072336582515e-01, ...
       2.7326630441178940e-01, 3.9786365002934432e-01, ...
       2.0729005746148721e-01, 1.4474479715392055e-01, ...
       2.7398057943131254e-01, 3.7398456595586516e-01, ...
       2.1492071060479609e-01, 1.5563505954646389e-01, ...
       2.7355646079950668e-01, 3.5588776905162367e-01, ...
       1.6610967047182590e-01, 1.9927576328975455e-01, ...
       3.5828839631621884e-01, 2.7632616992462883e-01, ...
       1.3356300794542819e-01, 1.7002139622173582e-01, ...
       4.2049222325374558e-01, 2.7592337258185307e-01, ...
       1.5433214203893464e-01, 1.8933465525438178e-01, ...
       3.7905222196765781e-01, 2.7728098074167240e-01, ...
       1.6441215541449541e-01, 1.9788978943243174e-01, ...
       3.6117150443887874e-01, 2.7652655071665361e-01, ...
       1.5238546583071191e-01, 1.8761788267514809e-01, ...
       3.8266269125158547e-01, 2.7733396024523760e-01, ...
       1.2906150825666157e-01, 1.6553024558811621e-01, ...
       4.3040078346987642e-01, 2.7500746268810822e-01, ...
       1.9015625124780128e-01, 1.5593743962069059e-01, ...
       4.2100023864182645e-01, 2.3290607049234341e-01, ...
       1.8394121808659003e-01, 1.4909096325002161e-01, ...
       4.3822016771167233e-01, 2.2874765095447522e-01, ...
       1.8788555408363414e-01, 1.5340903271920608e-01, ...
       4.2726748812004167e-01, 2.3143792507982613e-01, ...
       1.9618950889131420e-01, 1.6284949470257379e-01, ...
       4.0440016586921196e-01, 2.3656083053943555e-01, ...
       2.0635419802874549e-01, 1.7527720304832090e-01, ...
       3.7633555212093156e-01, 2.4203304680431162e-01, ...
       1.9615220312104828e-01, 1.6280577821496842e-01, ...
       4.0450290960573215e-01, 2.3653910906078784e-01, ...
       6.2221711459330643e-10, 6.2166082262653950e-10, ...
       8.1776665310134544e-01, 1.8223334565709448e-01, ...
       5.2670890124723533e-10, 5.2594442027836477e-10, ...
       8.3769798364385628e-01, 1.6230201530591129e-01, ...
       5.0237577575174802e-10, 5.0157768333045480e-10, ...
       8.4318357216880457e-01, 1.5681642682966301e-01, ...
       4.9401607388502620e-10, 4.9320810981943252e-10, ...
       8.4509733502995343e-01, 1.5490266398524366e-01, ...
       5.5881507130761621e-10, 5.5810636033582454e-10, ...
       8.3064952146594184e-01, 1.6935047741955789e-01, ...
       4.9815383549906847e-10, 4.9735065172288791e-10, ...
       8.4414821129773177e-01, 1.5585178770918487e-01]';

x_opt = x0;
f_opt = global_func_opt(x_opt, Q, nr, routes_coeffs, agent_route_list);

% Aeq = zeros(n, sum(nr));
% ptr = 1;
% for j = 1:n
%     % x0(ptr:ptr+nr(j)-1) = ones(nr(j), 1) / nr(j);
%     Aeq(j, (ptr:ptr+nr(j)-1)) = 1;
%     ptr = ptr + nr(j);
% end
% options = optimoptions('fmincon', 'SpecifyObjectiveGradient', true, ...
%     'OptimalityTolerance', 1e-12, 'ConstraintTolerance', 1e-12, ...
%     'Algorithm', 'sqp');
% fun = @(x)(global_func_opt(x, Q, nr, routes_coeffs, agent_route_list));
% [x_opt, f_opt] = fmincon(fun, x0, [], [], Aeq, ones(n,1), ones(sum(nr),1)*0.05/4,[],[],options);

save data m n G_adj dist_mat Bmax Q routes_coeffs agent_route_list nr fn_dependence f_opt;